- name: Code configuration | repos | Clone repos from Github (personal)
  tags: repos,git
  ignore_errors: yes
  ansible.builtin.git:
    repo: "git@github.com:{{ git_username }}/{{ item.name }}.git"
    dest: "{{ home_dir }}/code/my-repos/{{ item.name }}"
    update: no
    bare: "{{ item.bare | default(false) }}"
    clone: yes
  loop:
    - {"name": "ansible-system-setup"}
    - {"name": "dotfiles", "bare": true}
    - {"name": "dot-emacs"}
    - {"name": "zulip-helpers.el"}

- name: Emacs configuration | repos | Setup .emacs
  tags: repos,emacs
  ansible.builtin.file:
    src: /home/{{ username }}/code/my-repos/dot-emacs
    dest: /home/{{ username }}/.emacs.d
    state: link

- name: Dotfiles configuration git worktree setup | repos | Setup dot-files
  tags: repos,dotfiles
  copy:
    dest: "{{ home_dir }}/.git"
    content: |
      gitdir: {{ home_dir }}/code/my-repos/dotfiles/

- name: Dotfiles configuration | repos | Setup dot-files
  tags: repos,dotfiles
  ansible.builtin.shell: |
    # Required to use $HOME like a normal repo
    git --work-tree={{ home_dir }} --git-dir={{ home_dir }}/code/my-repos/dotfiles/ config core.bare false
    git --work-tree={{ home_dir }} --git-dir={{ home_dir }}/code/my-repos/dotfiles/ checkout || echo "Checkout exists"

    git --work-tree={{ home_dir }} --git-dir={{ home_dir }}/code/my-repos/dotfiles/ reset
